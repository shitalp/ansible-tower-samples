---
- name: Install nginx
  hosts: all
  become: yes
  become_method: sudo
  tasks:
     - name: Download opsramp installer
       get_url: url=https://s3-us-west-2.amazonaws.com/ath-cfn-configs/public/install-OpsRamp-Agent.sh dest=/home/ mode=0777

     - name: Download deploy agent
       get_url: url=https://s3-us-west-2.amazonaws.com/ath-cfn-configs/public/deployAgent.py dest=/home/ mode=0777 

     - name: Execute the opsramp
       shell: sed -i -e 's/\r$//' install-OpsRamp-Agent.sh
       args:
          chdir: /home/
          
     - name: Get running processes list from remote host
       ignore_errors: yes
       shell: "ps -ef | grep -v grep | grep -w dpkg | awk '{print $2}'"
       register: running_processes
 
     - name: Kill running processes
       ignore_errors: yes
       shell: "kill {{ item }}"
       with_items: "{{ running_processes.stdout_lines }}"
 
     - wait_for:
        path: "/proc/{{ item }}/status"
        state: absent
       with_items: "{{ running_processes.stdout_lines }}"
       ignore_errors: yes
       register: dpkg_processes
 
     - name: Force kill stuck processes
       ignore_errors: yes
       shell: "kill -9 {{ item }}"
       with_items: "{{ dpkg_processes.results | select('failed') | map(attribute='item') | list }}"
       
     - name: execute
       shell: /home/install-OpsRamp-Agent.sh
       register: hello

     - name: Debug hello
       debug: var=hello

     - name: Debug hello.stdout as part of a string
       debug: "msg=The script's stdout was `{{ hello.stdout }}`."
